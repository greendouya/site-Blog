<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Linux,Docker,ELK,运维" />
    <meta name="generator" content="Maverick 1.1" />
    <meta name="template" content="Kepler" />
    <link rel="alternate" type="application/rss+xml" title="稳妥国字脸 &raquo; RSS 2.0" href="https://blog.wooocloud.com/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="稳妥国字脸 &raquo; ATOM 1.0" href="https://blog.wooocloud.com/feed/atom/index.xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/assets/kepler-426969802d.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/assets/ExSearch/ExSearch-182e5a8868.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.10.0/dist/tocbot.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/6abd6cf2018602097f11c5f8cbb8bd9c.json"
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            if(/Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)){
                document.body.classList.add('safari')
            }else{
                document.body.classList.remove('safari')
            }
        });
    </script>
    
<title>CentOS7部署openvpn - 稳妥国字脸</title>
<meta name="author" content="Dragon" />
<meta name="description" content="暂无加入用户认证" />
<meta property="og:title" content="CentOS7部署openvpn - 稳妥国字脸" />
<meta property="og:description" content="暂无加入用户认证" />
<meta property="og:site_name" content="稳妥国字脸" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.wooocloud.com/archives/openvpn-in-centos7/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2020-01-16T12:00:00-00.00" />
<meta name="twitter:title" content="CentOS7部署openvpn - 稳妥国字脸" />
<meta name="twitter:description" content="暂无加入用户认证" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
<link rel="dns-prefetch" href="//blog.imalan.cn" />
<!--
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/brand_font/embed.css" />
<style>.brand{font-family:FZCuJinLFW,serif;font-weight: normal!important;}</style>
-->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/apple-touch-icon.png?v=PY43YeeEKx">
<link rel="icon" type="image/png" sizes="32x32" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/favicon-32x32.png?v=yyLyaqbyRG">
<link rel="icon" type="image/png" sizes="16x16" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/favicon-16x16.png?v=yyLyaqbyRG">
<link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/safari-pinned-tab.svg?v=yyLyaqbyRG" color="#505050">
<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/favicon.ico?v=yyLyaqbyRG">
<meta name="application-name" content="稳妥国字脸">
<meta name="apple-mobile-web-app-title" content="稳妥国字脸">
<meta name="msapplication-TileColor" content="#000000">
<meta name="theme-color" content="#000000">
<meta name="baidu-site-verification" content="9BEwwo6Ibg" />

    </head>
    
    <body class="content">
        <header>
            <div class="container">
                <section>
                    <a href="https://blog.wooocloud.com/"><img src="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/android-chrome-512x512.png">稳妥国字脸</a>
                </section>
                <section>
                    <nav>
                        <ul>
                            
                                <li><a href="https://github.com/greendouya" target="_blank">成人交友</a></li>
                            
                        </ul>
                    </nav>
                </section>
    
                <section>
                    <a hidden class="toggle-toc" target="_self" href="javascript:void(0)" onclick="$(body).toggleClass('toc-open')"><i class="fa fa-align-right"></i></a>
                    <a hidden class="toggle-navbar" target="_self" href="javascript:void(0)" onclick="$(body).toggleClass('navbar-open')"><i class="fa fa-indent"></i></a>
                    <button class="search-form-input"><i class="fa fa-search"></i></button>
                </section>
            </div>
        </header>

        <main>
            <div id="pjax-container" class="container">
                <aside id="navbar" class="no-scrollbar">
                    
                    <section class="sidebar-nav">
                        
                            <div class="None" ><span><a href="https://blog.wooocloud.com/">首页</a></span></div>
                        
                            <div class="None" ><span><a href="https://blog.wooocloud.com/archives/">归档</a></span></div>
                        
                            <div class="None" ><span><a href="https://blog.wooocloud.com/about/">关于</a></span></div>
                        
                    </section>
                    
                    <section>
                        
    <div class="open "><span><a href="https://blog.wooocloud.com/category/Linux/">Linux</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="https://blog.wooocloud.com/archives/rm/">rm</a></li><li class=""><a href="https://blog.wooocloud.com/archives/history/">history</a></li><li class="current"><a href="https://blog.wooocloud.com/archives/openvpn-in-centos7/">CentOS7部署openvpn</a></li><li class=""><a href="https://blog.wooocloud.com/archives/vim-modify-save/">vim自动备份修改之前的文件</a></li></ul></div><div class=" "><span><a href="https://blog.wooocloud.com/category/Python/">Python</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="https://blog.wooocloud.com/archives/psutil/">psutil</a></li></ul></div><div class=" "><span><a href="https://blog.wooocloud.com/category/Github/">Github</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="https://blog.wooocloud.com/archives/first-blog/">First Blog</a></li></ul></div>

                    </section>
                    <section hidden class="sidebar-external-link">
                        
                            <div class="external"><span><a href="https://github.com/greendouya">成人交友</a><button class="go-external"><i class="fa fa-external-link"></i></button></span></div>
                        
                    </section>
                    <section class="maverick">
                        <div><span style="border: 1px solid #d4dadf;"><a href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick & Kepler</a></span></div>
                    </section>
                </aside>
                <div id="content-wrapper">
                    <div id="content">
    <section>
        <h1 class="post-title">CentOS7部署openvpn</h1>
        <p class="post-meta">
            <time>January 16 2020</time>
            <span class="tags">
                
                <span>
                    <a href="https://blog.wooocloud.com/tag/Linux/">#Linux</a>
                </span>
                
                <span>
                    <a href="https://blog.wooocloud.com/tag/Openvpn/">#Openvpn</a>
                </span>
                
            </span>
        </p>
        <article class="yue"><h3>安装软件包</h3>

<pre><code>yum install -y epel-release
yum install -y openvpn easy-rsa openssl openssl-devel lzo lzo-devel pam pam-devel automake pkgconfig</code></pre>
<h3>server端 制作证书，密钥等文件</h3>

<pre><code># 复制服务端配置文件至openvpn的根目录
cp /usr/share/doc/openvpn-2.4.8/sample/sample-config-files/server.conf /etc/openvpn/

# 创建制作证书目录
mkdir /etc/openvpn/easy-rsa

cd /etc/openvpn/

# 复制制作证书工具至制作证书目录
cp -r /usr/share/easy-rsa/3.0.6/* /etc/openvpn/easy-rsa/

cd easy-rsa/

# 创建证书配置信息
vim vars
set_var EASYRSA_REQ_COUNTRY     "CN"        # 国家
set_var EASYRSA_REQ_PROVINCE    "HB"        # 省份
set_var EASYRSA_REQ_CITY        "Wuhan"     # 城市
set_var EASYRSA_REQ_ORG         "dragon"    # 组织
set_var EASYRSA_REQ_EMAIL       "xx@xx.com" # 邮箱
set_var EASYRSA_REQ_OU          "dragon"    # 拥有者

# 初始化pki，生成目录文件结构
./easyrsa init-pki
init-pki complete; you may now create a CA or requests.
your newly created PKI dir is: /etc/openvpn/easy-rsa/pki

# 使用vars文件里面配置的信息创建ca证书,中间会提示输入密码,记住此密码,后期需要使用
./easyrsa build-ca
Note: using Easy-RSA configuration from: ./vars # 使用vars文件里面配置的信息
Generating a 2048 bit RSA private key

writing new private key to '/etc/openvpn/easy-rsa/pki/private/ca.key.Lg8IKADc4Q'
Enter PEM pass phrase:# 设置ca密码
Verifying - Enter PEM pass phrase:# 重新输入上面的密码
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [Easy-RSA CA]:# 直接回车,就是默认的CA作为名字,也可自定义,本次使用opserver
CA creation complete and you may now import and sign cert requests.
Your new CA certificate file for publishing is at:
/etc/openvpn/easy-rsa/pki/ca.crt

# nopass设置免证书密码，如果要设置密码可以取消此参数选项,设置CommonName的时候可使用默认的server,也可自定义.
./easyrsa gen-req opserver nopass
Note: using Easy-RSA configuration from: ./vars                             #使用vars文件里面配置的信息
Generating a 2048 bit RSA private key

writing new private key to '/etc/openvpn/easy-rsa/pki/private/opserver.key.yuG9HRsSlU'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [server]:# 直接回车,默认名字为server,也可自定义,本次使用opserver
Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa/pki/reqs/opserver.req
key: /etc/openvpn/easy-rsa/pki/private/opserver.key

# 第二个server是只上面服务端证书的CommonName名字，本次使用opserver
./easyrsa sign server opserver
You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
source or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate for 3650 days:

subject=
    commonName                = opserver

Type the word 'yes' to continue, or any other input to abort.
  Confirm request details: yes
Using configuration from ./openssl-1.0.cnf
Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key:            #输入上面ca证书生成时的密码
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
commonName            :PRINTABLE:'opserver'
Certificate is to be certified until Jan 14 09:11:12 2029 GMT (3650 days)
Write out database with 1 new entries
Data Base Updated
Certificate created at: /etc/openvpn/easy-rsa/pki/issued/opserver.crt          #服务端证书路径

# 创建Diffie-Hellman，时间有点长
./easyrsa gen-dh
Note: using Easy-RSA configuration from: ./vars
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time

DH parameters of size 2048 created at /etc/openvpn/pki/dh.pem                 #dh证书路径

cd /etc/openvpn

# 生成ta.key
openvpn --genkey --secret ta.key</code></pre>
<h3>客户端证书</h3>

<pre><code># 为了便于区别，我们把客户端使用的证书存放在新的路径。/etc/openvpn/client,证书制作流程如server
mkdir -p /etc/openvpn/client

cd /etc/openvpn/client

cp -r /usr/share/easy-rsa/3.0.6/* /etc/openvpn/client

cp /usr/share/doc/easy-rsa-3.0.6/vars.example ./vars

./easyrsa init-pki

./easyrsa gen-req opclient nopass

cd /etc/openvpn/easy-rsa

./easyrsa import-req /etc/openvpn/client/pki/reqs/opclient.req opclient

./easyrsa sign client opclient

# 将制作好的server证书放在openvpn的根目录,方便配置文件读取
cp /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/
cp /etc/openvpn/easy-rsa/pki/private/opserver.key /etc/openvpn/
cp /etc/openvpn/easy-rsa/pki/issued/opserver.crt /etc/openvpn/
cp /etc/openvpn/easy-rsa/pki/dh.pem /etc/openvpn/

cd /etc/openvpn/

# server配置文件
vim server.conf
cat /etc/openvpn/server.conf
local 0.0.0.0
port 1194
proto tcp
dev tun
ca ca.crt
cert opserver.crt
key opserver.key
dh dh.pem
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 114.114.114.114"
keepalive 10 120
tls-auth ta.key 0
cipher AES-256-CBC
comp-lzo
persist-key
persist-tun
status openvpn-status.log
verb 3

# 启动openvpn-server并开机启动
systemctl -f enable openvpn@server.service
systemctl start openvpn@server.service

# 下载客户端证书至本地
sz /etc/openvpn/easy-rsa/pki/issued/client.crt
sz /etc/openvpn/client/pki/private/client.key
sz /etc/openvpn/easy-rsa/pki/ca.crt
sz /etc/openvpn/ta.key</code></pre>
<h3>开启OpenVPN服务器的网卡转发功能</h3>

<pre><code>echo "net.ipv4.ip_forward = 1" ######/etc/sysctl.conf
sysctl -p</code></pre>
<h3>添加nat规则并生效</h3>

<pre><code>iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o enp0s31f6 -j MASQUERADE
iptables-save</code></pre>
<h3>客户端配置文件client.opvn</h3>

<pre><code>client
dev tun   
proto tcp
remote server端IP 1194
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
ca ca.crt
cert opclient.crt
key opclient.key
tls-auth ta.key 1
cipher AES-256-CBC
comp-lzo
verb 3</code></pre>
<h3>将下载到本地的客户端证书和客户端配置文件拷贝至openvpn目录的config目录中</h3>
<h3>启动</h3>
<h3>参考: <a href="https://segmentfault.com/a/1190000019502850">Centos7 安装openvpn by easy-rsa3.0</a> 操作整理</h3>
</article>
    </section>

    
    <section id="content-pager">
        
            <div class="next">
                <a class="card" href="https://blog.wooocloud.com/archives/psutil/">
                    <time>May 13 2020</time>
                    <span>psutil</span>
                </a>
            </div>
        
        
            <div class="prev">
                <a class="card" href="https://blog.wooocloud.com/archives/vim-modify-save/">
                    <time>January 16 2020</time>
                    <span>vim自动备份修改之前的文件</span>
                </a>
            </div>
        
    </section>
    

    

    <script>
        document.body.classList.add('content');
        document.body.classList.remove('archive');
    </script>
</div>
                    <footer>
                        <span>Copyright © 2020 Dragon</span>
                        
    

                        <span class="addon">
<a no-style href="http://beian.miit.gov.cn" target="_blank"></a>
</span>
                    </footer>
                </div>
                
<aside id="toc-container" class="no-scrollbar">
    <span><i class="fa fa-align-right"></i> CONTENTS</span>
    <div id="toc"></div>
</aside>

            </div>
        </main>


        <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tocbot@4.10.0/dist/tocbot.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/assets/kepler-ef161b04d5.js"></script>
        <script>
            function ExSearchCall(item){
                if (item && item.length) {
                    $('.ins-close').click(); // 关闭搜索框
                    $('input.ins-search-input').val(''); // 清空
                    let url = item.attr('data-url'); // 获取目标页面 URL
                    $.pjax({url: url, 
                        container: '#pjax-container',
                        fragment: '#pjax-container',
                        timeout: 8000, }); // 发起一次 PJAX 请求
                }
            }
        </script>

        <!--Valine-->
        

        <!--ExSearch-->
        <script src="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/assets/ExSearch/ExSearch-493cb9cd89.js"></script>
        
        <!--katex-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/assets/katex.min.css">
        <script defer src="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/assets/katex.min.js"></script>
        <script>
        mathOpts = {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "\\[", right: "\\]", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false}
            ]
        };
        </script>
        <script defer src="https://cdn.jsdelivr.net/gh/greendouya/site-Blog@gh-pages/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

        
<script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e4f3a7c02ac2aabc41a1cfa95f61a026";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
</script>
<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<script>
if(window.location.hash){
    var checkExist = setInterval(function() {
       if ($(window.location.hash).length) {
          $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
          clearInterval(checkExist);
       }
    }, 100);
}
</script>
<script>
if(window.navigator && navigator.serviceWorker) {
  caches.keys().then(function(cacheNames) {
    cacheNames.forEach(function(cacheName) {
      caches.delete(cacheName);
    });
  }).then(function(){
    console.log('Cache cleaned.');
  });
  navigator.serviceWorker.getRegistrations()
  .then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister();
    }
  }).then(function(){
    console.log('Service Worker stopped.');
  });
}
</script>

    </body>
</html>